<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebView API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .test-section {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:disabled {
            background-color: #95a5a6;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            min-height: 20px;
        }
        .success {
            color: #27ae60;
        }
        .error {
            color: #c0392b;
        }
        .not-available {
            color: #d35400;
        }
        .info {
            color: #2980b9;
        }
        .warning {
            color: #f39c12;
        }
    </style>
</head>
<body>
    <h1>Test API WebView Android</h1>
    <p>Questa pagina testa le API JavaScript disponibili in una WebView Android e i permessi associati.</p>

    <div class="test-section">
        <h2>1. Camera e Microfono</h2>
        <p>API: <code>navigator.mediaDevices.getUserMedia()</code></p>
        <button id="testCamera">Test Camera</button>
        <button id="testMic">Test Microfono</button>
        <div class="result" id="mediaResult"></div>
        <video id="videoPreview" width="320" height="240" autoplay muted style="display: none;"></video>
    </div>

    <div class="test-section">
        <h2>2. Geolocalizzazione</h2>
        <p>API: <code>navigator.geolocation.getCurrentPosition()</code></p>
        <button id="testGeo">Test Geolocalizzazione</button>
        <div class="result" id="geoResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Accesso File</h2>
        <p>API: <code>FileReader.readAsDataURL()</code></p>
        <input type="file" id="fileInput" style="display: none;">
        <button id="testFile">Seleziona File</button>
        <div class="result" id="fileResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Clipboard API</h2>
        <p>API: <code>navigator.clipboard.writeText()</code> e <code>navigator.clipboard.readText()</code></p>
        <button id="testClipboardWrite">Scrivi negli Appunti</button>
        <button id="testClipboardRead">Leggi dagli Appunti</button>
        <div class="result" id="clipboardResult"></div>
    </div>

    <div class="test-section">
        <h2>8. Network Information</h2>
        <p>API: <code>navigator.connection.addEventListener()</code></p>
        <button id="testConnection">Test Connessione</button>
        <div class="result" id="connectionResult"></div>
    </div>

    <div class="test-section">
        <h2>12. Credential Management</h2>
        <p>API: <code>navigator.credentials.get()</code> e <code>navigator.credentials.store()</code></p>
        <button id="testCredentials">Test Credenziali</button>
        <div class="result" id="credentialsResult"></div>
        <div class="result" id="passwordCredResult"></div>
        <div class="result" id="federatedCredResult"></div>
        <div class="result" id="allCredResult"></div>
        <button id="clearCredentials">Cancella Credenziali</button>
        <div class="result" id="clearResult"></div>
    </div>

    <div class="test-section">
        <h2>16. Contact Picker API</h2>
        <p>API: <code>navigator.contacts.select()</code></p>
        <button id="testContacts">Test Contatti</button>
        <div class="result" id="contactsResult"></div>
    </div>

    <div class="test-section">
        <h2>19. Media Devices</h2>
        <p>API: <code>navigator.mediaDevices.enumerateDevices()</code></p>
        <button id="testEnumerateDevices">Test Enumerazione Dispositivi</button>
        <div class="result" id="enumerateDevicesResult"></div>
    </div>

    <script>
        // Funzione di utilità per aggiornare i risultati
        function updateResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error(`Elemento con ID ${elementId} non trovato`);
                return;
            }
            element.innerHTML = message.replace(/\n/g, '<br>');
            element.className = 'result ' + (type || '');
        }

        // Verifica la disponibilità di un'API
        function checkAvailability(apiPath, elementId) {
            const parts = apiPath.split('.');
            let current = window;
            
            for (const part of parts) {
                if (current && part in current) {
                    current = current[part];
                } else {
                    updateResult(elementId, 'API non disponibile: ' + apiPath, 'not-available');
                    return false;
                }
            }
            
            if (typeof current === 'function' || typeof current === 'object') {
                updateResult(elementId, 'API disponibile: ' + apiPath, 'success');
                return true;
            } else {
                updateResult(elementId, 'API non disponibile correttamente: ' + apiPath, 'not-available');
                return false;
            }
        }

        // 1. Camera e Microfono
        document.getElementById('testCamera').addEventListener('click', async () => {
            if (!checkAvailability('navigator.mediaDevices.getUserMedia', 'mediaResult')) return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const videoElement = document.getElementById('videoPreview');
                videoElement.style.display = 'block';
                videoElement.srcObject = stream;
                updateResult('mediaResult', 'Camera accessibile! Il video è mostrato sotto.', 'success');
                
                // Stop stream dopo 3 secondi
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    videoElement.style.display = 'none';
                    videoElement.srcObject = null;
                }, 3000);
            } catch (err) {
                updateResult('mediaResult', 'Errore accesso camera: ' + err.message, 'error');
            }
        });

        document.getElementById('testMic').addEventListener('click', async () => {
            if (!checkAvailability('navigator.mediaDevices.getUserMedia', 'mediaResult')) return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                updateResult('mediaResult', 'Microfono accessibile!', 'success');
                
                // Stop stream dopo 3 secondi
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                }, 3000);
            } catch (err) {
                updateResult('mediaResult', 'Errore accesso microfono: ' + err.message, 'error');
            }
        });

        // 2. Geolocalizzazione
        document.getElementById('testGeo').addEventListener('click', () => {
            if (!checkAvailability('navigator.geolocation.getCurrentPosition', 'geoResult')) return;
            
            try {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateResult('geoResult', `Geolocalizzazione funzionante! Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`, 'success');
                    },
                    (err) => {
                        updateResult('geoResult', 'Errore geolocalizzazione: ' + err.message, 'error');
                    }
                );
            } catch (err) {
                updateResult('geoResult', 'Errore geolocalizzazione: ' + err.message, 'error');
            }
        });


// 2. file system
document.getElementById('testFile').addEventListener('click', () => {
  apriELeggiFileComeDataURL();
});

async function apriELeggiFileComeDataURL() {
  try {
    // 1. Mostra il selettore file e ottieni il file handle
    const [fileHandle] = await window.showOpenFilePicker({
      types: [
        {
          description: 'Tutti i file',
          accept: {
            '*/*': ['./*']
          }
        }
      ],
      excludeAcceptAllOption: false,
      multiple: false
    });
    
    // 2. Usa getFile() per ottenere il File oggetto dal file handle
    const file = await fileHandle.getFile();
    console.log(`File selezionato: ${file.name}, ${file.size} bytes`);
    
    // 3. Crea un FileReader per leggere il contenuto come DataURL
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataURL = e.target.result;
      console.log("Contenuto DataURL:", dataURL);
      
      // Mostra il risultato, ad esempio in una <img> se è un'immagine
      const preview = document.getElementById('preview');
      if (preview) {
        preview.src = dataURL;
      }
    };
    
    reader.onerror = (e) => {
      console.error("Errore durante la lettura del file:", e.target.error);
    };
    
    // 4. Legge il file come DataURL
    reader.readAsDataURL(file);
  } catch (err) {
    console.error("Errore generale:", err);
  }
}

        // 8. Network Information
        document.getElementById('testConnection').addEventListener('click', () => {
            if (!checkAvailability('navigator.connection', 'connectionResult')) return;
            
            try {
                const connection = navigator.connection || 
                                 navigator.mozConnection || 
                                 navigator.webkitConnection;
                
                if (connection) {
                    let info = `Tipo: ${connection.type || 'N/A'}, `;
                    info += `Effettivo: ${connection.effectiveType || 'N/A'}, `;
                    info += `Downlink: ${connection.downlink || 'N/A'} Mbps, `;
                    info += `RTT: ${connection.rtt || 'N/A'} ms, `;
                    info += `Saving: ${connection.saveData ? 'Sì' : 'No'}`;
                    
                    updateResult('connectionResult', info, 'success');
                    
                    connection.addEventListener('change', () => {
                        updateResult('connectionResult', 'Evento change ricevuto!', 'success');
                    });
                } else {
                    updateResult('connectionResult', 'API Connection disponibile ma non accessibile correttamente', 'not-available');
                }
            } catch (err) {
                updateResult('connectionResult', 'Errore connection info: ' + err.message, 'error');
            }
        });

        // 12. Credential Management
        document.getElementById('testCredentials').addEventListener('click', async () => {
            if (!('credentials' in navigator)) {
                updateResult('credentialsResult', 'API Credential Management non supportata nel browser.', 'error');
                return;
            }
            
            // Test di tutte le credenziali disponibili
            await testPasswordCredential();
            await testFederatedCredential();
            await testGetAllCredentials();
        });

        // Test delle credenziali di tipo password
        async function testPasswordCredential() {
            if (!('PasswordCredential' in window)) {
                updateResult('passwordCredResult', 'PasswordCredential non supportata nel browser.', 'error');
                return;
            }
            
            updateResult('passwordCredResult', 'Test PasswordCredential in corso...', 'info');
            
            const passwordCredential = new PasswordCredential({
                id: 'test@example.com',
                password: 'password123',
                name: 'Test User',
                iconURL: 'https://example.com/icon.png' // Opzionale
            });
            
            try {
                // Salvataggio della credenziale
                await navigator.credentials.store(passwordCredential);
                updateResult('passwordCredResult', 'PasswordCredential salvata correttamente!', 'success');
                
                // Recupero della credenziale
                setTimeout(async () => {
                    try {
                        const cred = await navigator.credentials.get({
                            password: true,
                            mediation: 'optional'
                        });
                        
                        if (cred) {
                            updateResult('passwordCredResult', 
                                `PasswordCredential recuperata:
                                ID: ${cred.id}
                                Nome: ${cred.name || 'N/A'}
                                Tipo: ${cred.type}`, 
                                'success');
                        } else {
                            updateResult('passwordCredResult', 'Nessuna PasswordCredential trovata o l\'utente ha rifiutato', 'warning');
                        }
                    } catch (getErr) {
                        updateResult('passwordCredResult', 'Errore nel recupero della PasswordCredential: ' + getErr.message, 'error');
                    }
                }, 1000);
            } catch (storeErr) {
                updateResult('passwordCredResult', 'Errore nel salvataggio della PasswordCredential: ' + storeErr.message, 'error');
            }
        }

        // Test delle credenziali federate
        async function testFederatedCredential() {
            if (!('FederatedCredential' in window)) {
                updateResult('federatedCredResult', 'FederatedCredential non supportata nel browser.', 'error');
                return;
            }
            
            updateResult('federatedCredResult', 'Test FederatedCredential in corso...', 'info');
            
            const federatedCredential = new FederatedCredential({
                id: 'test@example.com',
                provider: 'https://accounts.google.com',
                name: 'Test User',
                iconURL: 'https://example.com/icon.png' // Opzionale
            });
            
            try {
                // Salvataggio della credenziale
                await navigator.credentials.store(federatedCredential);
                updateResult('federatedCredResult', 'FederatedCredential salvata correttamente!', 'success');
                
                // Recupero della credenziale
                setTimeout(async () => {
                    try {
                        const cred = await navigator.credentials.get({
                            federated: {
                                providers: ['https://accounts.google.com']
                            },
                            mediation: 'optional'
                        });
                        
                        if (cred && cred.type === 'federated') {
                            updateResult('federatedCredResult', 
                                `FederatedCredential recuperata:
                                ID: ${cred.id}
                                Provider: ${cred.provider}
                                Nome: ${cred.name || 'N/A'}
                                Tipo: ${cred.type}`, 
                                'success');
                        } else {
                            updateResult('federatedCredResult', 'Nessuna FederatedCredential trovata o l\'utente ha rifiutato', 'warning');
                        }
                    } catch (getErr) {
                        updateResult('federatedCredResult', 'Errore nel recupero della FederatedCredential: ' + getErr.message, 'error');
                    }
                }, 2000);
            } catch (storeErr) {
                updateResult('federatedCredResult', 'Errore nel salvataggio della FederatedCredential: ' + storeErr.message, 'error');
            }
        }

        // Test per recuperare tutte le credenziali disponibili
        async function testGetAllCredentials() {
            updateResult('allCredResult', 'Test di recupero di tutte le credenziali in corso...', 'info');
            
            setTimeout(async () => {
                try {
                    // Tenta di recuperare qualsiasi tipo di credenziale
                    const cred = await navigator.credentials.get({
                        password: true,
                        federated: {
                            providers: ['https://accounts.google.com']
                        },
                        mediation: 'optional'
                    });
                    
                    if (cred) {
                        updateResult('allCredResult', 
                            `Credenziale recuperata:
                            Tipo: ${cred.type}
                            ID: ${cred.id}
                            Nome: ${cred.name || 'N/A'}
                            ${cred.type === 'federated' ? 'Provider: ' + cred.provider : ''}`, 
                            'success');
                    } else {
                        updateResult('allCredResult', 'Nessuna credenziale trovata o l\'utente ha rifiutato', 'warning');
                    }
                } catch (getErr) {
                    updateResult('allCredResult', 'Errore nel recupero delle credenziali: ' + getErr.message, 'error');
                }
            }, 3000);
        }

        // Funzione per cancellare le credenziali
        document.getElementById('clearCredentials').addEventListener('click', async () => {
            if (!('credentials' in navigator)) {
                updateResult('clearResult', 'API Credential Management non supportata nel browser.', 'error');
                return;
            }
            
            try {
                // La funzione preventSilentAccess impedisce il recupero automatico
                // delle credenziali senza l'interazione dell'utente
                await navigator.credentials.preventSilentAccess();
                updateResult('clearResult', 'Credenziali cancellate/disattivate correttamente!', 'success');
            } catch (error) {
                updateResult('clearResult', 'Errore nella cancellazione delle credenziali: ' + error.message, 'error');
            }
        });

        // 16. Contact Picker API
        document.getElementById('testContacts').addEventListener('click', async () => {
            if (!checkAvailability('navigator.contacts', 'contactsResult')) return;
            
            try {
                const contacts = await navigator.contacts.select(['name', 'email', 'tel'], { multiple: true });
                if (contacts.length > 0) {
                    updateResult('contactsResult', `Contatti selezionati: ${contacts.length}`, 'success');
                } else {
                    updateResult('contactsResult', 'Nessun contatto selezionato', 'error');
                }
            } catch (err) {
                updateResult('contactsResult', 'Errore Contact Picker: ' + err.message, 'error');
            }
        });

        // 19. Media Devices
        document.getElementById('testEnumerateDevices').addEventListener('click', async () => {
            if (!checkAvailability('navigator.mediaDevices.enumerateDevices', 'enumerateDevicesResult')) return;
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                let deviceList = 'Dispositivi trovati:<br>';
                
                devices.forEach(device => {
                    deviceList += `- ${device.kind}: ${device.label || 'Nessuna etichetta'} (${device.deviceId.substring(0, 8)}...)<br>`;
                });
                
                updateResult('enumerateDevicesResult', deviceList || 'Nessun dispositivo trovato', devices.length > 0 ? 'success' : 'error');
            } catch (err) {
                updateResult('enumerateDevicesResult', 'Errore enumerateDevices: ' + err.message, 'error');
            }
        });
    </script>
</body>
</html>
