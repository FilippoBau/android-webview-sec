<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebView API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .test-section {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:disabled {
            background-color: #95a5a6;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 5px;
            min-height: 20px;
        }
        .success {
            color: #27ae60;
        }
        .error {
            color: #c0392b;
        }
        .not-available {
            color: #d35400;
        }
    </style>
</head>
<body>
    <h1>Test API WebView Android</h1>
    <p>Questa pagina testa le API JavaScript disponibili in una WebView Android e i permessi associati.</p>

    <div class="test-section">
        <h2>1. Camera e Microfono</h2>
        <p>API: <code>navigator.mediaDevices.getUserMedia()</code></p>
        <button id="testCamera">Test Camera</button>
        <button id="testMic">Test Microfono</button>
        <div class="result" id="mediaResult"></div>
        <video id="videoPreview" width="320" height="240" autoplay muted style="display: none;"></video>
    </div>

    <div class="test-section">
        <h2>2. Geolocalizzazione</h2>
        <p>API: <code>navigator.geolocation.getCurrentPosition()</code></p>
        <button id="testGeo">Test Geolocalizzazione</button>
        <div class="result" id="geoResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Accesso File</h2>
        <p>API: <code>FileReader.readAsDataURL()</code></p>
        <input type="file" id="fileInput" style="display: none;">
        <button id="testFile">Seleziona File</button>
        <div class="result" id="fileResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Clipboard API</h2>
        <p>API: <code>navigator.clipboard.writeText()</code> e <code>navigator.clipboard.readText()</code></p>
        <button id="testClipboardWrite">Scrivi negli Appunti</button>
        <button id="testClipboardRead">Leggi dagli Appunti</button>
        <div class="result" id="clipboardResult"></div>
    </div>

    <div class="test-section">
        <h2>5. Orientamento Schermo</h2>
        <p>API: <code>screen.orientation.lock()</code></p>
        <button id="testOrientation">Blocca Orientamento</button>
        <button id="unlockOrientation">Sblocca Orientamento</button>
        <div class="result" id="orientationResult"></div>
    </div>

    <div class="test-section">
        <h2>6. Notifiche</h2>
        <p>API: <code>Notification.requestPermission()</code></p>
        <button id="testNotifications">Test Notifiche</button>
        <div class="result" id="notificationsResult"></div>
    </div>

    <div class="test-section">
        <h2>7. Web Share API</h2>
        <p>API: <code>navigator.share()</code></p>
        <button id="testShare">Test Condivisione</button>
        <div class="result" id="shareResult"></div>
    </div>

    <div class="test-section">
        <h2>8. Network Information</h2>
        <p>API: <code>navigator.connection.addEventListener()</code></p>
        <button id="testConnection">Test Connessione</button>
        <div class="result" id="connectionResult"></div>
    </div>

    <div class="test-section">
        <h2>9. Service Worker</h2>
        <p>API: <code>navigator.serviceWorker.register()</code></p>
        <button id="testServiceWorker">Test Service Worker</button>
        <div class="result" id="serviceWorkerResult"></div>
    </div>

    <div class="test-section">
        <h2>10. Bluetooth</h2>
        <p>API: <code>navigator.bluetooth.requestDevice()</code></p>
        <button id="testBluetooth">Test Bluetooth</button>
        <div class="result" id="bluetoothResult"></div>
    </div>

    <div class="test-section">
        <h2>11. Beacon API</h2>
        <p>API: <code>navigator.sendBeacon()</code></p>
        <button id="testBeacon">Test Beacon</button>
        <div class="result" id="beaconResult"></div>
    </div>

    <div class="test-section">
        <h2>12. Credential Management</h2>
        <p>API: <code>navigator.credentials.get()</code> e <code>navigator.credentials.store()</code></p>
        <button id="testCredentials">Test Credenziali</button>
        <div class="result" id="credentialsResult"></div>
    </div>

    <div class="test-section">
        <h2>13. WebUSB API</h2>
        <p>API: <code>navigator.usb.requestDevice()</code></p>
        <button id="testUsb">Test USB</button>
        <div class="result" id="usbResult"></div>
    </div>

    <div class="test-section">
        <h2>14. Media Session API</h2>
        <p>API: <code>navigator.mediaSession.setActionHandler()</code></p>
        <button id="testMediaSession">Test Media Session</button>
        <div class="result" id="mediaSessionResult"></div>
    </div>

    <div class="test-section">
        <h2>15. Fullscreen API</h2>
        <p>API: <code>element.requestFullscreen()</code></p>
        <button id="testFullscreen">Test Fullscreen</button>
        <div class="result" id="fullscreenResult"></div>
    </div>

    <div class="test-section">
        <h2>16. Contact Picker API</h2>
        <p>API: <code>navigator.contacts.select()</code></p>
        <button id="testContacts">Test Contatti</button>
        <div class="result" id="contactsResult"></div>
    </div>

    <div class="test-section">
        <h2>17. Permissions API</h2>
        <p>API: <code>navigator.permissions.query()</code></p>
        <button id="testPermissions">Test Permessi</button>
        <div class="result" id="permissionsResult"></div>
    </div>

    <div class="test-section">
        <h2>18. Web Share Check</h2>
        <p>API: <code>navigator.canShare()</code></p>
        <button id="testCanShare">Test canShare</button>
        <div class="result" id="canShareResult"></div>
    </div>

    <div class="test-section">
        <h2>19. Media Devices</h2>
        <p>API: <code>navigator.mediaDevices.enumerateDevices()</code></p>
        <button id="testEnumerateDevices">Test Enumerazione Dispositivi</button>
        <div class="result" id="enumerateDevicesResult"></div>
    </div>

    <script>
        // Funzione di utilità per aggiornare i risultati
        function updateResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = 'result ' + (type || '');
        }

        // Verifica la disponibilità di un'API
        function checkAvailability(apiPath, elementId) {
            const parts = apiPath.split('.');
            let current = window;
            
            for (const part of parts) {
                if (current && part in current) {
                    current = current[part];
                } else {
                    updateResult(elementId, 'API non disponibile: ' + apiPath, 'not-available');
                    return false;
                }
            }
            
            if (typeof current === 'function' || typeof current === 'object') {
                updateResult(elementId, 'API disponibile: ' + apiPath, 'success');
                return true;
            } else {
                updateResult(elementId, 'API non disponibile correttamente: ' + apiPath, 'not-available');
                return false;
            }
        }

        // 1. Camera e Microfono
        document.getElementById('testCamera').addEventListener('click', async () => {
            if (!checkAvailability('navigator.mediaDevices.getUserMedia', 'mediaResult')) return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const videoElement = document.getElementById('videoPreview');
                videoElement.style.display = 'block';
                videoElement.srcObject = stream;
                updateResult('mediaResult', 'Camera accessibile! Il video è mostrato sotto.', 'success');
                
                // Stop stream dopo 3 secondi
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    videoElement.style.display = 'none';
                    videoElement.srcObject = null;
                }, 3000);
            } catch (err) {
                updateResult('mediaResult', 'Errore accesso camera: ' + err.message, 'error');
            }
        });

        document.getElementById('testMic').addEventListener('click', async () => {
            if (!checkAvailability('navigator.mediaDevices.getUserMedia', 'mediaResult')) return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                updateResult('mediaResult', 'Microfono accessibile!', 'success');
                
                // Stop stream dopo 3 secondi
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                }, 3000);
            } catch (err) {
                updateResult('mediaResult', 'Errore accesso microfono: ' + err.message, 'error');
            }
        });

        // 2. Geolocalizzazione
        document.getElementById('testGeo').addEventListener('click', () => {
            if (!checkAvailability('navigator.geolocation.getCurrentPosition', 'geoResult')) return;
            
            try {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateResult('geoResult', `Geolocalizzazione funzionante! Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`, 'success');
                    },
                    (err) => {
                        updateResult('geoResult', 'Errore geolocalizzazione: ' + err.message, 'error');
                    }
                );
            } catch (err) {
                updateResult('geoResult', 'Errore geolocalizzazione: ' + err.message, 'error');
            }
        });

        // 3. Accesso File
        document.getElementById('testFile').addEventListener('click', () => {
            if (!checkAvailability('FileReader', 'fileResult')) return;
            
            const fileInput = document.getElementById('fileInput');
            fileInput.click();
        });

        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                updateResult('fileResult', 'Nessun file selezionato', 'error');
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = (e) => {
                    updateResult('fileResult', `File letto correttamente! Nome: ${file.name}, Dimensione: ${file.size} bytes`, 'success');
                };
                reader.onerror = (e) => {
                    updateResult('fileResult', 'Errore lettura file: ' + e.target.error, 'error');
                };
                reader.readAsDataURL(file);
            } catch (err) {
                updateResult('fileResult', 'Errore accesso file: ' + err.message, 'error');
            }
        });

        // 4. Clipboard API
        document.getElementById('testClipboardWrite').addEventListener('click', async () => {
            if (!checkAvailability('navigator.clipboard.writeText', 'clipboardResult')) return;
            
            try {
                await navigator.clipboard.writeText('Test WebView ' + new Date().toLocaleTimeString());
                updateResult('clipboardResult', 'Testo copiato negli appunti!', 'success');
            } catch (err) {
                updateResult('clipboardResult', 'Errore scrittura clipboard: ' + err.message, 'error');
            }
        });

        document.getElementById('testClipboardRead').addEventListener('click', async () => {
            if (!checkAvailability('navigator.clipboard.readText', 'clipboardResult')) return;
            
            try {
                const text = await navigator.clipboard.readText();
                updateResult('clipboardResult', 'Testo dagli appunti: ' + text, 'success');
            } catch (err) {
                updateResult('clipboardResult', 'Errore lettura clipboard: ' + err.message, 'error');
            }
        });

        // 5. Orientamento Schermo
        document.getElementById('testOrientation').addEventListener('click', async () => {
            if (!checkAvailability('screen.orientation.lock', 'orientationResult')) return;
            
            try {
                await screen.orientation.lock('portrait');
                updateResult('orientationResult', 'Orientamento bloccato in portrait!', 'success');
            } catch (err) {
                updateResult('orientationResult', 'Errore blocco orientamento: ' + err.message, 'error');
            }
        });

        document.getElementById('unlockOrientation').addEventListener('click', () => {
            if (!checkAvailability('screen.orientation.unlock', 'orientationResult')) return;
            
            try {
                screen.orientation.unlock();
                updateResult('orientationResult', 'Orientamento sbloccato!', 'success');
            } catch (err) {
                updateResult('orientationResult', 'Errore sblocco orientamento: ' + err.message, 'error');
            }
        });

        // 6. Notifiche
        document.getElementById('testNotifications').addEventListener('click', async () => {
            if (!checkAvailability('Notification.requestPermission', 'notificationsResult')) return;
            
            try {
                const permission = await Notification.requestPermission();
                updateResult('notificationsResult', 'Permesso notifiche: ' + permission, 'success');
                
                if (permission === 'granted') {
                    const notification = new Notification('Test WebView', {
                        body: 'Notifica di test dalla WebView',
                        icon: 'https://via.placeholder.com/64'
                    });
                }
            } catch (err) {
                updateResult('notificationsResult', 'Errore notifiche: ' + err.message, 'error');
            }
        });

        // 7. Web Share API
        document.getElementById('testShare').addEventListener('click', async () => {
            if (!checkAvailability('navigator.share', 'shareResult')) return;
            
            try {
                await navigator.share({
                    title: 'Test WebView',
                    text: 'Test della Web Share API in WebView',
                    url: window.location.href
                });
                updateResult('shareResult', 'Condivisione avvenuta con successo!', 'success');
            } catch (err) {
                if (err.name === 'AbortError') {
                    updateResult('shareResult', 'Condivisione annullata dall\'utente', 'error');
                } else {
                    updateResult('shareResult', 'Errore condivisione: ' + err.message, 'error');
                }
            }
        });

        // 8. Network Information
        document.getElementById('testConnection').addEventListener('click', () => {
            if (!checkAvailability('navigator.connection', 'connectionResult')) return;
            
            try {
                const connection = navigator.connection || 
                                   navigator.mozConnection || 
                                   navigator.webkitConnection;
                
                if (connection) {
                    let info = `Tipo: ${connection.type || 'N/A'}, `;
                    info += `Effettivo: ${connection.effectiveType || 'N/A'}, `;
                    info += `Downlink: ${connection.downlink || 'N/A'} Mbps, `;
                    info += `RTT: ${connection.rtt || 'N/A'} ms, `;
                    info += `Saving: ${connection.saveData ? 'Sì' : 'No'}`;
                    
                    updateResult('connectionResult', info, 'success');
                    
                    connection.addEventListener('change', () => {
                        updateResult('connectionResult', 'Evento change ricevuto!', 'success');
                    });
                } else {
                    updateResult('connectionResult', 'API Connection disponibile ma non accessibile correttamente', 'not-available');
                }
            } catch (err) {
                updateResult('connectionResult', 'Errore connection info: ' + err.message, 'error');
            }
        });

        // 9. Service Worker
        document.getElementById('testServiceWorker').addEventListener('click', async () => {
            if (!checkAvailability('navigator.serviceWorker.register', 'serviceWorkerResult')) return;
            
            try {
                // Creiamo un service worker minimale
                const swBlob = new Blob([`
                    self.addEventListener('install', event => {
                        self.skipWaiting();
                    });
                    self.addEventListener('activate', event => {
                        event.waitUntil(clients.claim());
                    });
                `], { type: 'text/javascript' });
                
                const swUrl = URL.createObjectURL(swBlob);
                const registration = await navigator.serviceWorker.register(swUrl, { scope: './' });
                
                updateResult('serviceWorkerResult', 'Service Worker registrato con successo!', 'success');
                
                // Pulizia dopo alcuni secondi
                setTimeout(() => {
                    registration.unregister().then(success => {
                        if (success) updateResult('serviceWorkerResult', 'Service Worker deregistrato', 'success');
                    });
                    URL.revokeObjectURL(swUrl);
                }, 3000);
            } catch (err) {
                updateResult('serviceWorkerResult', 'Errore Service Worker: ' + err.message, 'error');
            }
        });

        // 10. Bluetooth
        document.getElementById('testBluetooth').addEventListener('click', async () => {
            if (!checkAvailability('navigator.bluetooth.requestDevice', 'bluetoothResult')) return;
            
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true
                });
                updateResult('bluetoothResult', `Dispositivo Bluetooth selezionato: ${device.name || 'Senza nome'}`, 'success');
            } catch (err) {
                if (err.name === 'NotFoundError') {
                    updateResult('bluetoothResult', 'Nessun dispositivo Bluetooth trovato', 'error');
                } else if (err.name === 'SecurityError') {
                    updateResult('bluetoothResult', 'API Bluetooth bloccata per motivi di sicurezza nella WebView', 'error');
                } else {
                    updateResult('bluetoothResult', 'Errore Bluetooth: ' + err.message, 'error');
                }
            }
        });

        // 11. Beacon API
        document.getElementById('testBeacon').addEventListener('click', () => {
            if (!checkAvailability('navigator.sendBeacon', 'beaconResult')) return;
            
            try {
                // Usiamo un endpoint di test
                const data = new Blob(['Test Beacon API'], { type: 'text/plain' });
                const result = navigator.sendBeacon('https://httpbin.org/post', data);
                updateResult('beaconResult', result ? 'Beacon inviato con successo!' : 'Invio beacon fallito', result ? 'success' : 'error');
            } catch (err) {
                updateResult('beaconResult', 'Errore Beacon: ' + err.message, 'error');
            }
        });

        // 12. Credential Management
function isWebView() {
    return /wv/.test(navigator.userAgent) || /Android.*Version\/[\d.]+.*Chrome\/[\d.]+ Mobile/.test(navigator.userAgent);
}

document.getElementById('testCredentials').addEventListener('click', async () => {
    if (isWebView()) {
        updateResult('credentialsResult', 'WebView non supporta le credenziali di tipo PasswordCredential.', 'error');
        return;
    }

    if (!('credentials' in navigator) || !('PasswordCredential' in window)) {
        updateResult('credentialsResult', 'API non supportata nel browser.', 'error');
        return;
    }

    const credential = new PasswordCredential({
        id: 'test@example.com',
        password: 'password123',
        name: 'Test User'
    });

    try {
        await navigator.credentials.store(credential);
        updateResult('credentialsResult', 'Credenziali salvate correttamente!', 'success');
    } catch (storeErr) {
        updateResult('credentialsResult', 'Errore nel salvataggio delle credenziali: ' + storeErr.message, 'error');
        return;
    }

    setTimeout(async () => {
        try {
            const cred = await navigator.credentials.get({
                password: true,
                mediation: 'optional'
            });

            if (cred) {
                updateResult('credentialsResult', 'Credenziali recuperate: ' + cred.id, 'success');
            } else {
                updateResult('credentialsResult', 'Nessuna credenziale trovata o l\'utente ha rifiutato', 'error');
            }
        } catch (getErr) {
            updateResult('credentialsResult', 'Errore nel recupero delle credenziali: ' + getErr.message, 'error');
        }
    }, 1000);
});


        // 13. WebUSB API
        document.getElementById('testUsb').addEventListener('click', async () => {
            if (!checkAvailability('navigator.usb.requestDevice', 'usbResult')) return;
            
            try {
                const device = await navigator.usb.requestDevice({ filters: [] });
                updateResult('usbResult', `Dispositivo USB selezionato: ${device.productName || 'Sconosciuto'}`, 'success');
            } catch (err) {
                if (err.name === 'NotFoundError') {
                    updateResult('usbResult', 'Nessun dispositivo USB trovato', 'error');
                } else {
                    updateResult('usbResult', 'Errore WebUSB: ' + err.message, 'error');
                }
            }
        });

        // 14. Media Session API
        document.getElementById('testMediaSession').addEventListener('click', () => {
            if (!checkAvailability('navigator.mediaSession', 'mediaSessionResult')) return;
            
            try {
                // Creiamo un elemento audio invisibile per attivare il media session
                const audio = new Audio();
                audio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
                audio.loop = true;
                
                // Impostiamo i metadati
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'Test Media Session',
                    artist: 'WebView Test',
                    album: 'Test Album',
                    artwork: [{ src: 'https://via.placeholder.com/96', sizes: '96x96', type: 'image/png' }]
                });
                
                // Impostiamo gli handler
                navigator.mediaSession.setActionHandler('play', () => {
                    audio.play();
                    updateResult('mediaSessionResult', 'Media Session: evento play ricevuto!', 'success');
                });
                
                navigator.mediaSession.setActionHandler('pause', () => {
                    audio.pause();
                    updateResult('mediaSessionResult', 'Media Session: evento pause ricevuto!', 'success');
                });
                
                updateResult('mediaSessionResult', 'Media Session configurata correttamente!', 'success');
                
                // Pulizia dopo alcuni secondi
                setTimeout(() => {
                    audio.pause();
                    audio.src = '';
                }, 5000);
            } catch (err) {
                updateResult('mediaSessionResult', 'Errore Media Session: ' + err.message, 'error');
            }
        });

        // 15. Fullscreen API
        document.getElementById('testFullscreen').addEventListener('click', async () => {
            if (!checkAvailability('document.documentElement.requestFullscreen', 'fullscreenResult')) return;
            
            try {
                await document.documentElement.requestFullscreen();
                updateResult('fullscreenResult', 'Fullscreen attivato!', 'success');
                
                // Usciamo dal fullscreen dopo pochi secondi
                setTimeout(() => {
                    if (document.fullscreenElement) {
                        document.exitFullscreen().then(() => {
                            updateResult('fullscreenResult', 'Uscito da fullscreen', 'success');
                        });
                    }
                }, 3000);
            } catch (err) {
                updateResult('fullscreenResult', 'Errore Fullscreen: ' + err.message, 'error');
            }
        });

        // 16. Contact Picker API
        document.getElementById('testContacts').addEventListener('click', async () => {
            if (!checkAvailability('navigator.contacts', 'contactsResult')) return;
            
            try {
                const contacts = await navigator.contacts.select(['name', 'email', 'tel'], { multiple: true });
                if (contacts.length > 0) {
                    updateResult('contactsResult', `Contatti selezionati: ${contacts.length}`, 'success');
                } else {
                    updateResult('contactsResult', 'Nessun contatto selezionato', 'error');
                }
            } catch (err) {
                updateResult('contactsResult', 'Errore Contact Picker: ' + err.message, 'error');
            }
        });

        // 17. Permissions API
        document.getElementById('testPermissions').addEventListener('click', async () => {
            if (!checkAvailability('navigator.permissions.query', 'permissionsResult')) return;
            
            try {
                const permissionsList = ['geolocation', 'camera', 'microphone', 'notifications'];
                let results = '';
                
                for (const permission of permissionsList) {
                    try {
                        const status = await navigator.permissions.query({ name: permission });
                        results += `${permission}: ${status.state}<br>`;
                    } catch (err) {
                        results += `${permission}: non supportato<br>`;
                    }
                }
                
                updateResult('permissionsResult', results, 'success');
            } catch (err) {
                updateResult('permissionsResult', 'Errore Permissions API: ' + err.message, 'error');
            }
        });

        // 18. Web Share Check
        document.getElementById('testCanShare').addEventListener('click', () => {
            if (!checkAvailability('navigator.canShare', 'canShareResult')) return;
            
            try {
                const shareData = {
                    title: 'Test WebView',
                    text: 'Test della Web Share API in WebView',
                    url: window.location.href
                };
                
                const canShare = navigator.canShare(shareData);
                updateResult('canShareResult', canShare ? 'È possibile condividere questo contenuto' : 'Non è possibile condividere questo contenuto', canShare ? 'success' : 'error');
            } catch (err) {
                updateResult('canShareResult', 'Errore canShare: ' + err.message, 'error');
            }
        });

        // 19. Media Devices
        document.getElementById('testEnumerateDevices').addEventListener('click', async () => {
            if (!checkAvailability('navigator.mediaDevices.enumerateDevices', 'enumerateDevicesResult')) return;
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                let deviceList = 'Dispositivi trovati:<br>';
                
                devices.forEach(device => {
                    deviceList += `- ${device.kind}: ${device.label || 'Nessuna etichetta'} (${device.deviceId.substring(0, 8)}...)<br>`;
                });
                
                updateResult('enumerateDevicesResult', deviceList || 'Nessun dispositivo trovato', devices.length > 0 ? 'success' : 'error');
            } catch (err) {
                updateResult('enumerateDevicesResult', 'Errore enumerateDevices: ' + err.message, 'error');
            }
        });
    </script>
</body>
</html>
